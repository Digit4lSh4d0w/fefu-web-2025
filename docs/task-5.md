# Задание №5

## Критерии оценивания

| №   | Задача                                   | Количество баллов | Выполнено ? |
| --- | ---------------------------------------- | ----------------- | ----------- |
| 1   | Установка и настройка ПО                 | 5                 | ✅          |
| 2   | Миграция на PostgreSQL                   | 5                 | ✅          |
| 3   | Настройка PostgreSQL                     | 5                 | ✅          |
| 4   | Настройка Gunicorn                       | 5                 | ✅          |
| 5   | Настройка Nginx                          | 5                 | ✅          |
| 6   | Скрипт для автоматического развертывания | 5                 | ✅          |
| 7   | Работоспособность приложения             | 5                 | ✅          |

## Отчет

Веб-сервер Nginx настроен на обслуживание домена `fefu-django-app` (на подобии `localhost`)
на 80 порту (без HTTPS). Доступ возможен как с гостевой машины (с добавлением домена в hosts),
так и с хостовой (с добавлением домена в hosts).

Во всех случаях Nginx корректно обслуживает статические ресурсы (CSS и JS).

В качестве гостевой ОС был выбран `Debian 13`.

Была произведена миграция базы данных с `SQLite` на `PostgreSQL` с сохранением данных.

Для соблюдения базовых правил безопасности - сервисы прослушивают только необходимые адреса.

Вывод команды `ss -tulpn | grep -e ':\(80\|5432\|8000\)'`:

```plaintext
tcp   LISTEN 0      511                              0.0.0.0:80        0.0.0.0:*    users:(("nginx",pid=6146,fd=5),...)
tcp   LISTEN 0      511                                 [::]:80           [::]:*    users:(("nginx",pid=6146,fd=6),...)
tcp   LISTEN 0      200                            127.0.0.1:5432      0.0.0.0:*    users:(("postgres",pid=6021,fd=7))
tcp   LISTEN 0      200                                [::1]:5432         [::]:*    users:(("postgres",pid=6021,fd=6))
tcp   LISTEN 0      2048                           127.0.0.1:8000      0.0.0.0:*    users:(("gunicorn",pid=6181,fd=6),...)
tcp   LISTEN 0      2048                               [::1]:8000         [::]:*    users:(("gunicorn",pid=6181,fd=7),...)
```

Как можно видеть - `postgres` и `gunicorn` прослушивают адреса только с кольцевого интерфейса,
в то время как `nginx` - абсолютно все.

Для автоматического развертывания были созданы вспомогательные файлы:

- `gunicorn/gunicorn.service` - `systemd unit` файл, представляющий сервис,
  управляемый демоном `systemd`.
- `nginx/fefu-lab.conf` - файл, описывающий демону `nginx` какой домен прослушивать,
  куда проксировать запросы и откуда обслуживать статику.
- `postgres/init.sql` - `SQL` скрипт, инициализирующий окружение для веб-сервиса - создает
  пользователя (с паролем) и базу данных.
- `postgres/pg_hba.conf` - файл, описывающий методы аутентификации пользователей в СУБД.

Скрипт `scripts/deploy.fish` написан диалекте `shell` - `fish`, исполняющемся в одноименной
командной оболочке. Диалект использован ради интереса.
Сам скрипт реализует все стадии развертывания сервиса - от установки утилит (`curl`, `git`, ...),
до создания сервисов `systemd` и их запуска.
Процесс развертывания можно посмотреть в видео ниже.

<details>
  <summary>Скриншоты</summary>
  <h4>Главная страница</h4>
  <a href="../assets/task-5/main-page.webp">
    <img src="../assets/task-5/main-page.webp" width="600"/>
  </a>
</details>

<details>
  <summary>Видео</summary>
  <h4>Процесс автоматического развертывания</h4>
  <a href="../assets/task-5/auto-deploy-process.webm">Видео</a>
</details>
